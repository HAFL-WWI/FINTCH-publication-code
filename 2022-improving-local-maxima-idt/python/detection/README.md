# Individual tree detection with pyFINT

## Overview
The scripts in this folder are used to perform the actual individual tree detection using [pyFINT](https://github.com/HAFL-WWI/pyFINT) for local maxima detection. The process uses pyFINT at its core and sets the filters in pyFINT based on forest structure types. While the code has some similarities to the code in the [FINT-CH project](https://github.com/HAFL-WWI/pyFINT/tree/master/FINT_CH_Process), the actual process is structured differently since it is focused on the application to sample plots of the Swiss national forest inventory instead of a area-wide application to a grid. The process itself is governed by different configuration and data inputs. For its outputs the process relies on a PostgreSQL Database with PostGIS extension for data storage. 

The provided files can be divided as follows:
- __Common/fintch_utilities.py__: A script with helper functions used by other scripts.
- __Config/*.*__: Files concerning the configuration of the process. Example files for the process are included but need to be modified to suit the respective environment.
- __Processing/fintch_processing_core_pub.py__: This script implements the core logging of the actual process including the derivation of forest structure types, derivation of terrain variables, tree detection with pyFINT, generation of combination methods (incorporating detections of multiple filters), and data storage/processing.
- __Processing/fintch_processing_process_pub.py__: This script is responsible for setting up the actual detection process including configuration, plot handling, and parallelization. All pre-processing methods are applied to all inventory plots to generate the inptus for the subsequent analysis. 

## Prerequisites
### Data
Due to the large data volume and license issues no data is provided. Note that all geodata is expected to have the same projection. For the paper the EPSG 2056/LV95 was used as projection but any other projected coordinate system should work.

#### Perimeters
The process operates allows for sets of distinct input data organised in perimeters. The perimeters themselves don't have to be present as input during processing but may be needed to prepare the other inputs (plot centers, Canopy Height Model, Mixing Degree).

#### Plot Centers
The process operates on a ESRI shapefile containing the center coordinates of the sample plots as point geometries. The file must have a column with a unique OBJECTID per perimeter. Each feature also requires an attribute with the ID of the containing perimeter that matches to the Flaeche_ID attribute in the provided Perimeter Config CSV.

#### Canopy Height Model
A normalized surface model respectively a Canopy Height Model (CHM) must be provided as GeoTIFF raster. The CHM is used as input for the actual tree detection. Each perimeter may use a separate CHM raster. CHM with a resolution of 1m derived from ALS data with high point density (&ge;15 points/m2) is recommended as input. Higher resolutions of &lt;1m would work but lower resolutions of &gt;1m would interfere with the filter logic defined in our method.

#### Canopy Height Model 1.5m
For the derivation of the forest structure type a 1.5m resolution version of the CHM aggregated with the MAX function as GeoTIFF is needed as input. To speed up the process this version of the CHM raster has to be pre-generated and provided as separate input. The aggregation of the CHM to 1.5m resolution can be generated by any GIS software supporting resampling/aggregation of rasters with the MAX function. The use of gdalwarp is recommended. Again, each perimeter may use a separate 1.5m CHM raster.

#### Dominant Leaf Type 10m
The dominant leaf type respectively mixing degree with a 10m raster resolution as GeoTIFF is needed as input for the forest structure type derivation. The pixels are expected to have a value between 0 and 10000 encoding the values 0.00% to 100.00%. The NFI Forest mix rate (https://opendata.swiss/en/dataset/waldmischungsgrad-lfi) is a suitable input. Separate rasters per perimeter are possible.

#### Digital Elevation Model 25m
The digital elevation model (DEM) with 25m resolution in the GeoTIFF format is used to derive terrain variables. Any digital elevation model may be used as basis to generate this raster. For the publication [DHM25](https://www.swisstopo.admin.ch/de/geodata/height/dhm25.html) from swisstopo was used, that is  available as Open Data. Note that the DEM is configured globally and not per perimeter.

#### Vegetation Height Zones
The vegetation height zones were used as additional candidate for explanatory variables. The data needs to be provided as ESRI file geodatabase. The original data is available as [Open Data](https://data.geo.admin.ch/ch.bafu.wald-vegetationshoehenstufen_1995/data.zip). Note that the vegetation height zones are configured globally and not per perimeter.
    
### Database
The process requires a PostgreSQL database with installed PostGIS extension for storing the detection results. PostgreSQL 10 or higher is recommended. The database, a target schema, and a user need to be manually created and configured beforehand. The user needs privileges to create and delete tables on the target schema. Its credentials along with the database connection information have to be specified in the configuration. The necessary database tables are created by the process itself.

### Environment
The process expects several environment variables pointing to specific locations containing artifacts required by the process.

#### PYFINT_HOME
The PYFINT_HOME environment variable point to the folder containing the pyFINT scripts. The pyFINT module is loaded from that path.

#### FINTCH_HOME
The FINTCH_HOME environment variable point to the folder containing the files connected to the detection process. That folder is expected to contain the /Common subfolder containing the fintch_utilities.py script. The entire folder is loaded as a module.

#### FINTCH_CONFIG_HOME
This FINTCH_CONFIG_HOME environment variable points to the folder containing FINTCH_config.ini config file.

### Configuration 
#### General Config: FINTCH_config.ini
Part of the process relies on configurations provided by a file called FINTCH_config.ini. Since this file contains sensitive credential information it can be located in a separate location, which is indicated by the FINTCH_CONFIG_HOME environment variable. A sample config file named FINTCH_config_sample.ini is provided with this repository. You are advised to copy this file and modify it to match your environment. The following entries have to be modified:
- result_base_path: Path for temporary files during detection (may need a lot of space depending on the detected area)
- log_path: Path for saving the log file from the process
- crs and epsg: these two entries should be modified such that the EPSG code matches the CRS of the input geodata.
- host, port, dbname, user, password: connection information for the PostgreSQL database used in the process. The user needs to have the right to delete and create tables on the target schema (configured in the main script)

#### Perimeter Config CSV
This file is central for defining the perimeters that contain the inventory plots processed by the script. Every row in this CSV represents a distinct perimeter that may contain plot centers. In order to do so, a number of data inputs need to be configured row each perimeter. This is done using a CSV that is expected to have the following columns:
- Flaeche_ID: Unique ID of the perimeter that will be matched to the perimeter polygon ID
- VHM: Path to the original resolution CHM GeoTIFF raster. 
- Mischungsgrad: Path to the Mixing Degree GeoTIFF raster.
- VHM_150: Path to the 1.5m MAX aggregated CHM GeoTIFF.

An example CSV named kantone_info.csv is provided with this repository. 

#### Configs in main script
Several configurations are made by setting variable values directly in the main script as they may change with each execution:
- result_base_path: Path to store temporary results
- flaechen_info_path: Path to the CSV with the perimeter configurations
- flaeche_id_column: Name of the ID column in the plot center shapefile that identifies the containing perimeter
- dhm_path: Path to 25m resolution DHM GeoTIFF.
- veg_zone_gdb_path: path to the ESRI file geodatabase vontaining the vegetation height zones
- plot_radius: Radius used to buffer the plot centers in order to generate the are that is detected (note that for the publication the actual detection was performed on a larger radius than the outer NFI plot radius and the threes were reduced to the proper plot aria during data preparation)
- table_schema: Name of the database schema to create the result tables in. The configured user needs to have the right to create and delete tables in this schema.
- table_base_name: Prefix added to the names of the result tables.
- table_owner: name of the user that is set as owner of the created result tables.

Additionally, the num_processes parameter in the process_setup() function calls should be modified to match your system. The parameter indicates the number of processes used for parallelization. The number should not be higher than the number of available cores. For the forest structure derivation more than 15 processes have shown to actually prolong the overall process.

## Usage
The program has been written for Python 3.x. See requirements.txt for dependencies. In the FINT-CH project Python 3.7.x was used. Carefully read the Prerequisites chapter and prepare your environment accordingly. Once the prerequisite configurations are met, the fintch_processing_process_kantone.py can be executed to perform the actual detection. Note that the script deletes existing result tables in the PostgreSQL database. If older results have to be preserved, a different schema or a different table prefix should be used. 

Inputs:
- See Prerequisites

Outputs:
- Database: 
    - &lt;schema&gt;.&lt;prefix&gt;_tree_detected: This table contains the detected trees for all plots and filter combinations. 
    - &lt;schema&gt;.&lt;prefix&gt;_perimeter: Contrary to the name this table does not contain the perimeter outlines but the outlines of the individual plots that are used for the actual detections. 
    - &lt;schema&gt;.&lt;prefix&gt;_fst_raster: This table contains a polygon grid with cells of 25m by 25m size with their respective forest structure type. These cells are used to determine the forest structure variables per plot.
- Filesystem: In the folder configured in the result_base_path setting folders for the individual tiles with the raw detection inputs and outputs of pyFINT are created. For the FINT-CH process these are considered temporary files and may be deleted safely if the process has succeeded. 

## Links
- FINT-CH Project Report (in German): https://www.ecorisq.org/relevant-literature/fint/58-final-report-fint-ch-project-in-german/file
- pyFINT download page ecorisQ: https://www.ecorisq.org/ecorisq-tools
